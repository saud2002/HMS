<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports & Analytics - HMS</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <div class="sidebar" id="sidebar"></div>
    <div class="topbar" id="topbar"></div>

    <div class="main-content">
        <!-- Tab Buttons -->
        <div class="tab-buttons no-print">
            <button class="tab-btn active" onclick="showReportTab('doctor')">Doctor Report</button>
            <button class="tab-btn" onclick="showReportTab('hospital')">Hospital Report</button>
            <button class="tab-btn" onclick="showReportTab('summary')">Summary Report</button>
        </div>

        <!-- Doctor Report Tab -->
        <div id="doctorReportTab">
            <div class="card no-print">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Select Doctor</label>
                        <select id="reportDoctor">
                            <option value="">-- All Doctors --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="reportStartDate">
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" id="reportEndDate">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-primary" onclick="generateDoctorReport()">Generate Report</button>
                    </div>
                </div>
            </div>
            <div class="card" id="doctorReportContent" style="display: none;"></div>
        </div>

        <!-- Hospital Report Tab -->
        <div id="hospitalReportTab" style="display: none;">
            <div class="card no-print">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="hospitalStartDate">
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" id="hospitalEndDate">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-primary" onclick="generateHospitalReport()">Generate Report</button>
                    </div>
                </div>
            </div>
            <div class="card" id="hospitalReportContent" style="display: none;"></div>
        </div>

        <!-- Summary Report Tab -->
        <div id="summaryReportTab" style="display: none;">
            <div class="card no-print">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Report Date</label>
                        <input type="date" id="summaryDate">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-primary" onclick="generateSummaryReport()">Generate Daily Summary</button>
                    </div>
                </div>
            </div>
            <div class="card" id="summaryReportContent" style="display: none;"></div>
        </div>
    </div>

    <script src="/static/js/data.js"></script>
    <script src="/static/js/common.js"></script>
    <script src="/static/js/api.js"></script>
    <script>
        // Tab switching
        function showReportTab(tab) {
            document.querySelectorAll('.tab-btn').forEach((b, i) => {
                b.classList.toggle('active', 
                    (tab === 'doctor' && i === 0) || 
                    (tab === 'hospital' && i === 1) ||
                    (tab === 'summary' && i === 2)
                );
            });
            document.getElementById('doctorReportTab').style.display = tab === 'doctor' ? 'block' : 'none';
            document.getElementById('hospitalReportTab').style.display = tab === 'hospital' ? 'block' : 'none';
            document.getElementById('summaryReportTab').style.display = tab === 'summary' ? 'block' : 'none';
        }

        // Populate doctor dropdown
        async function populateReportDropdowns() {
            try {
                const doctors = await API.Doctors.getAll('Active');
                document.getElementById('reportDoctor').innerHTML = 
                    '<option value="">-- All Doctors --</option>' +
                    doctors.map(d => `<option value="${d.doctor_id}">${d.doctor_name}</option>`).join('');
            } catch (error) {
                console.error('Error loading doctors:', error);
                showToast('Error loading doctors', 'error');
            }
        }

        // Generate Doctor Report - Enhanced with Patient Details Table
        async function generateDoctorReport() {
            const doctorId = document.getElementById('reportDoctor').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;

            if (!startDate || !endDate) {
                showToast('Please select both start and end dates', 'error');
                return;
            }

            try {
                // Get doctor-wise report data
                const doctorReport = await API.Reports.getDoctorWise(startDate, endDate);
                
                // Get appointments for the date range
                const appointments = await API.Appointments.getAll({
                    date_from: startDate,
                    date_to: endDate,
                    doctor_id: doctorId || undefined
                });

                // Find specific doctor data if selected
                let doctorData = null;
                let doctorPaymentStatus = 'Pending';
                let voucherInfo = null;
                
                if (doctorId) {
                    doctorData = doctorReport.find(d => d.doctor_id === doctorId);
                    if (!doctorData) {
                        doctorData = {
                            doctor_id: doctorId,
                            doctor_name: 'Unknown',
                            specialization: 'Unknown',
                            total_appointments: 0,
                            total_doctor_fees: 0,
                            payment_status: 'Pending'
                        };
                    }
                    doctorPaymentStatus = doctorData.payment_status || 'Pending';
                    if (doctorData.voucher_number) {
                        voucherInfo = {
                            voucher_number: doctorData.voucher_number,
                            paid_at: doctorData.paid_at
                        };
                    }
                } else {
                    // Aggregate all doctors
                    doctorData = {
                        doctor_name: 'All Doctors',
                        specialization: 'All Specializations',
                        total_appointments: doctorReport.reduce((sum, d) => sum + d.total_appointments, 0),
                        total_doctor_fees: doctorReport.reduce((sum, d) => sum + d.total_doctor_fees, 0)
                    };
                    // For all doctors, show mixed status if some are paid and some are pending
                    const paidDoctors = doctorReport.filter(d => d.payment_status === 'Paid').length;
                    const totalDoctors = doctorReport.length;
                    if (paidDoctors === 0) {
                        doctorPaymentStatus = 'Pending';
                    } else if (paidDoctors === totalDoctors) {
                        doctorPaymentStatus = 'Paid';
                    } else {
                        doctorPaymentStatus = `${paidDoctors}/${totalDoctors} Paid`;
                    }
                }

                // Calculate totals from appointments - Doctor Fees Only
                let totalDoctorFees = 0;

                appointments.forEach(appointment => {
                    totalDoctorFees += parseFloat(appointment.doctor_charges || 0);
                });

                const dateRange = startDate === endDate ? formatDate(startDate) : `${formatDate(startDate)} to ${formatDate(endDate)}`;

                // Create patient details table
                let patientDetailsTable = '';
                if (appointments.length > 0) {
                    patientDetailsTable = `
                        <h4>üìã Patient Details - Doctor Fees</h4>
                        <div style="overflow-x: auto; margin: 20px 0;">
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <thead style="background: #4f46e5; color: white;">
                                    <tr>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">S.No</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">Token/Bill No</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">Patient Name</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">NIC</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">Phone</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">Date</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid #e5e7eb;">Doctor Fee</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #e5e7eb;">Payment Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${appointments.map((appointment, index) => `
                                        <tr style="border-bottom: 1px solid #f3f4f6;">
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6;">${index + 1}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; font-weight: 600; color: #4f46e5;">${appointment.token_number || 'N/A'}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; font-weight: 500;">${appointment.patient_name || 'N/A'}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6;">${appointment.patient_nic || 'N/A'}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6;">${appointment.patient_phone || 'N/A'}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6;">${formatDate(appointment.appointment_date)}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; text-align: right; font-weight: 600; color: #059669;">LKR ${parseFloat(appointment.doctor_charges || 0).toFixed(2)}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; text-align: center;">
                                                <span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; 
                                                    ${appointment.payment_status === 'Paid' ? 'background: #dcfce7; color: #166534;' : 'background: #fef3c7; color: #92400e;'}">
                                                    ${appointment.payment_status || 'Pending'}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot style="background: #f8fafc; font-weight: 600;">
                                    <tr>
                                        <td colspan="6" style="padding: 12px; text-align: right; border-top: 2px solid #e5e7eb; font-size: 16px;">TOTAL DOCTOR FEES:</td>
                                        <td style="padding: 12px; text-align: right; border-top: 2px solid #e5e7eb; color: #4f46e5; font-size: 16px;">LKR ${totalDoctorFees.toFixed(2)}</td>
                                        <td style="padding: 12px; border-top: 2px solid #e5e7eb; text-align: center;">
                                            <span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; 
                                                ${doctorPaymentStatus === 'Paid' ? 'background: #dcfce7; color: #166534;' : 'background: #fef3c7; color: #92400e;'}">
                                                ${doctorPaymentStatus}
                                            </span>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    `;
                } else {
                    patientDetailsTable = `
                        <div style="margin: 20px 0; padding: 20px; background: #fef3c7; border-radius: 10px; text-align: center;">
                            <p style="margin: 0; color: #92400e;">No appointments found for the selected criteria.</p>
                        </div>
                    `;
                }

                document.getElementById('doctorReportContent').style.display = 'block';
                document.getElementById('doctorReportContent').innerHTML = `
                    <div class="card-title">üìä Doctor Report - ${dateRange}</div>
                    <p><strong>Doctor:</strong> ${doctorData.doctor_name} ${doctorData.specialization !== 'All Specializations' ? `(${doctorData.specialization})` : ''}</p>
                    <div style="margin: 20px 0; padding: 20px; background: #f8fafc; border-radius: 10px;">
                        <div class="bill-row"><span>Total Appointments</span><span><strong>${appointments.length}</strong></span></div>
                        <div class="bill-row bill-total"><span>TOTAL DOCTOR FEES</span><span><strong>LKR ${totalDoctorFees.toFixed(2)}</strong></span></div>
                        <div class="bill-row"><span>Payment Status</span><span style="font-weight: 600; color: ${doctorPaymentStatus === 'Paid' ? '#059669' : '#d97706'};">${doctorPaymentStatus}</span></div>
                        ${voucherInfo ? `<div class="bill-row"><span>Voucher Number</span><span><strong>${voucherInfo.voucher_number}</strong></span></div>` : ''}
                        ${voucherInfo && voucherInfo.paid_at ? `<div class="bill-row"><span>Paid Date</span><span>${new Date(voucherInfo.paid_at).toLocaleDateString()}</span></div>` : ''}
                        <div class="bill-row"><span>Report Generated</span><span>${new Date().toLocaleString()}</span></div>
                    </div>
                    
                    ${patientDetailsTable}
                    
                    ${doctorId && doctorPaymentStatus === 'Pending' ? `
                        <div style="margin: 20px 0; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <h5 style="margin: 0 0 10px 0; color: #92400e;">üí∞ Payment Action Required</h5>
                            <p style="margin: 0 0 15px 0; color: #92400e;">Doctor fees totaling LKR ${totalDoctorFees.toFixed(2)} are pending payment for the period ${dateRange}.</p>
                            <button class="btn btn-warning" onclick="createDoctorPaymentVoucher('${doctorId}', '${startDate}', '${endDate}', ${totalDoctorFees})">
                                üìÑ Create Payment Voucher
                            </button>
                        </div>
                    ` : ''}
                    
                    ${doctorId && doctorPaymentStatus === 'Paid' && voucherInfo ? `
                        <div style="margin: 20px 0; padding: 15px; background: #dcfce7; border-radius: 8px; border-left: 4px solid #059669;">
                            <h5 style="margin: 0 0 10px 0; color: #166534;">‚úÖ Payment Completed</h5>
                            <p style="margin: 0; color: #166534;">Doctor fees have been paid via voucher ${voucherInfo.voucher_number} on ${new Date(voucherInfo.paid_at).toLocaleDateString()}.</p>
                        </div>
                    ` : ''}
                    
                    ${!doctorId && doctorReport.length > 0 ? `
                        <h4>Doctor-wise Breakdown</h4>
                        <div style="margin: 15px 0; padding: 15px; background: #f8fafc; border-radius: 8px;">
                            ${doctorReport.map(d => 
                                `<div class="bill-row">
                                    <span>${d.doctor_name} (${d.specialization})</span>
                                    <span>${d.total_appointments} appointments - LKR ${d.total_doctor_fees.toFixed(2)} 
                                        <span style="margin-left: 10px; padding: 2px 6px; border-radius: 8px; font-size: 11px; font-weight: 500; 
                                            ${d.payment_status === 'Paid' ? 'background: #dcfce7; color: #166534;' : 'background: #fef3c7; color: #92400e;'}">
                                            ${d.payment_status || 'Pending'}
                                        </span>
                                        ${d.voucher_number ? `<br><small style="color: #64748b;">Voucher: ${d.voucher_number}</small>` : ''}
                                    </span>
                                </div>`
                            ).join('')}
                        </div>
                    ` : ''}
                    
                    <button class="btn btn-primary no-print" onclick="window.print()">üñ®Ô∏è Print Report</button>
                `;
            } catch (error) {
                console.error('Error generating doctor report:', error);
                showToast('Error generating report', 'error');
            }
        }

        // Create Doctor Payment Voucher
        async function createDoctorPaymentVoucher(doctorId, startDate, endDate, amount) {
            try {
                const voucherData = {
                    voucher_type: 'DOCTOR_PAYMENT',
                    doctor_id: doctorId,
                    payment_period_start: startDate,
                    payment_period_end: endDate,
                    amount: amount,
                    description: `Doctor payment for period ${startDate} to ${endDate}`,
                    status: 'PENDING_APPROVAL'
                };

                const response = await fetch('/api/vouchers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(voucherData)
                });

                if (response.ok) {
                    const voucher = await response.json();
                    showToast(`Payment voucher ${voucher.voucher_number} created successfully`, 'success');
                    
                    // Ask if user wants to go to vouchers page
                    if (confirm('Voucher created successfully! Would you like to go to the vouchers page to approve it?')) {
                        window.location.href = '/vouchers.html';
                    } else {
                        // Refresh the report to show updated status
                        generateDoctorReport();
                    }
                } else {
                    const error = await response.json();
                    showToast(`Error creating voucher: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Error creating voucher:', error);
                showToast('Error creating payment voucher', 'error');
            }
        }

        // Generate Hospital Report - Hospital Fees Only
        async function generateHospitalReport() {
            const startDate = document.getElementById('hospitalStartDate').value;
            const endDate = document.getElementById('hospitalEndDate').value;

            if (!startDate || !endDate) {
                showToast('Please select both start and end dates', 'error');
                return;
            }

            try {
                // Get appointments for the date range
                const appointments = await API.Appointments.getAll({
                    date_from: startDate,
                    date_to: endDate
                });

                // Calculate total hospital charges
                let totalHospitalCharges = 0;
                appointments.forEach(appointment => {
                    totalHospitalCharges += parseFloat(appointment.hospital_charges || 0);
                });

                const dateRange = startDate === endDate ? formatDate(startDate) : `${formatDate(startDate)} to ${formatDate(endDate)}`;

                // Create hospital charges details table
                let hospitalDetailsTable = '';
                if (appointments.length > 0) {
                    hospitalDetailsTable = `
                        <h4>üè• Hospital Charges Details</h4>
                        <div style="overflow-x: auto; margin: 20px 0;">
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <thead style="background: #059669; color: white;">
                                    <tr>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">S.No</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">Token/Bill No</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">Patient Name</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">Doctor</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">Date</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid #e5e7eb;">Hospital Charges</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #e5e7eb;">Payment Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${appointments.map((appointment, index) => `
                                        <tr style="border-bottom: 1px solid #f3f4f6;">
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6;">${index + 1}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; font-weight: 600; color: #059669;">${appointment.token_number || 'N/A'}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; font-weight: 500;">${appointment.patient_name || 'N/A'}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6;">${appointment.doctor_name || 'N/A'}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6;">${formatDate(appointment.appointment_date)}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; text-align: right; font-weight: 600; color: #059669;">LKR ${parseFloat(appointment.hospital_charges || 0).toFixed(2)}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; text-align: center;">
                                                <span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; 
                                                    ${appointment.payment_status === 'Paid' ? 'background: #dcfce7; color: #166534;' : 'background: #fef3c7; color: #92400e;'}">
                                                    ${appointment.payment_status || 'Pending'}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot style="background: #f0fdf4; font-weight: 600;">
                                    <tr>
                                        <td colspan="5" style="padding: 12px; text-align: right; border-top: 2px solid #e5e7eb; font-size: 16px;">TOTAL HOSPITAL CHARGES:</td>
                                        <td style="padding: 12px; text-align: right; border-top: 2px solid #e5e7eb; color: #059669; font-size: 16px;">LKR ${totalHospitalCharges.toFixed(2)}</td>
                                        <td style="padding: 12px; border-top: 2px solid #e5e7eb;"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    `;
                } else {
                    hospitalDetailsTable = `
                        <div style="margin: 20px 0; padding: 20px; background: #fef3c7; border-radius: 10px; text-align: center;">
                            <p style="margin: 0; color: #92400e;">No appointments found for the selected criteria.</p>
                        </div>
                    `;
                }

                document.getElementById('hospitalReportContent').style.display = 'block';
                document.getElementById('hospitalReportContent').innerHTML = `
                    <div class="card-title">üè• Hospital Report - ${dateRange}</div>
                    <p><strong>Focus:</strong> Hospital Charges Only</p>
                    <div style="margin: 20px 0; padding: 20px; background: #f0fdf4; border-radius: 10px;">
                        <div class="bill-row"><span>Total Appointments</span><span><strong>${appointments.length}</strong></span></div>
                        <div class="bill-row bill-total"><span>TOTAL HOSPITAL CHARGES</span><span><strong>LKR ${totalHospitalCharges.toFixed(2)}</strong></span></div>
                        <div class="bill-row"><span>Report Generated</span><span>${new Date().toLocaleString()}</span></div>
                    </div>
                    
                    ${hospitalDetailsTable}
                    
                    <button class="btn btn-primary no-print" onclick="window.print()">üñ®Ô∏è Print Report</button>
                `;
            } catch (error) {
                console.error('Error generating hospital report:', error);
                showToast('Error generating report', 'error');
            }
        }

        // Generate Summary Report - Patient Details Table
        async function generateSummaryReport() {
            const date = document.getElementById('summaryDate').value;

            if (!date) {
                showToast('Please select a date', 'error');
                return;
            }

            try {
                // Get appointments for the selected date
                const appointments = await API.Appointments.getAll({
                    date_from: date,
                    date_to: date
                });

                // Calculate totals from appointments
                let totalDoctorFees = 0;
                let totalHospitalCharges = 0;
                let totalAdditionalExpenses = 0;
                let totalAmount = 0;
                let completedCount = 0;
                let scheduledCount = 0;
                let cancelledCount = 0;

                appointments.forEach(appointment => {
                    totalDoctorFees += parseFloat(appointment.doctor_charges || 0);
                    totalHospitalCharges += parseFloat(appointment.hospital_charges || 0);
                    totalAdditionalExpenses += parseFloat(appointment.additional_expenses || 0);
                    totalAmount += parseFloat(appointment.bill_total || 0);
                    
                    // Count appointment statuses
                    const status = appointment.status || 'Scheduled';
                    if (status === 'Completed') completedCount++;
                    else if (status === 'Cancelled') cancelledCount++;
                    else scheduledCount++;
                });

                const completionRate = appointments.length > 0 ? Math.round((completedCount / appointments.length) * 100) : 0;

                // Create patient details table
                let patientDetailsTable = '';
                if (appointments.length > 0) {
                    patientDetailsTable = `
                        <h4>üìã Daily Patient Summary</h4>
                        <div style="overflow-x: auto; margin: 20px 0;">
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <thead style="background: #7c3aed; color: white;">
                                    <tr>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">S.No</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">Token/Bill No</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">Patient Name</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">Doctor</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid #e5e7eb;">Doctor Fee</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid #e5e7eb;">Hospital Charges</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid #e5e7eb;">Additional</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid #e5e7eb;">Total</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #e5e7eb;">Status</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #e5e7eb;">Payment</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${appointments.map((appointment, index) => `
                                        <tr style="border-bottom: 1px solid #f3f4f6;">
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6;">${index + 1}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; font-weight: 600; color: #7c3aed;">${appointment.token_number || 'N/A'}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; font-weight: 500;">${appointment.patient_name || 'N/A'}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6;">${appointment.doctor_name || 'N/A'}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; text-align: right;">LKR ${parseFloat(appointment.doctor_charges || 0).toFixed(2)}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; text-align: right;">LKR ${parseFloat(appointment.hospital_charges || 0).toFixed(2)}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; text-align: right;">LKR ${parseFloat(appointment.additional_expenses || 0).toFixed(2)}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; text-align: right; font-weight: 600;">LKR ${parseFloat(appointment.bill_total || 0).toFixed(2)}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; text-align: center;">
                                                <span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; 
                                                    ${appointment.status === 'Completed' ? 'background: #dcfce7; color: #166534;' : 
                                                      appointment.status === 'Cancelled' ? 'background: #fee2e2; color: #dc2626;' : 
                                                      'background: #dbeafe; color: #2563eb;'}">
                                                    ${appointment.status || 'Scheduled'}
                                                </span>
                                            </td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; text-align: center;">
                                                <span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; 
                                                    ${appointment.payment_status === 'Paid' ? 'background: #dcfce7; color: #166534;' : 'background: #fef3c7; color: #92400e;'}">
                                                    ${appointment.payment_status || 'Pending'}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot style="background: #faf5ff; font-weight: 600;">
                                    <tr>
                                        <td colspan="4" style="padding: 12px; text-align: right; border-top: 2px solid #e5e7eb; font-size: 16px;">TOTALS:</td>
                                        <td style="padding: 12px; text-align: right; border-top: 2px solid #e5e7eb;">LKR ${totalDoctorFees.toFixed(2)}</td>
                                        <td style="padding: 12px; text-align: right; border-top: 2px solid #e5e7eb;">LKR ${totalHospitalCharges.toFixed(2)}</td>
                                        <td style="padding: 12px; text-align: right; border-top: 2px solid #e5e7eb;">LKR ${totalAdditionalExpenses.toFixed(2)}</td>
                                        <td style="padding: 12px; text-align: right; border-top: 2px solid #e5e7eb; color: #7c3aed; font-size: 16px;">LKR ${totalAmount.toFixed(2)}</td>
                                        <td colspan="2" style="padding: 12px; border-top: 2px solid #e5e7eb;"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    `;
                } else {
                    patientDetailsTable = `
                        <div style="margin: 20px 0; padding: 20px; background: #fef3c7; border-radius: 10px; text-align: center;">
                            <p style="margin: 0; color: #92400e;">No appointments found for the selected date.</p>
                        </div>
                    `;
                }

                document.getElementById('summaryReportContent').style.display = 'block';
                document.getElementById('summaryReportContent').innerHTML = `
                    <div class="card-title">üìà Daily Summary Report - ${formatDate(date)}</div>
                    
                    <div class="form-grid" style="margin: 20px 0;">
                        <div class="card" style="text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <h3 style="margin: 0; font-size: 2em;">${appointments.length}</h3>
                            <p style="margin: 5px 0;">Total Appointments</p>
                        </div>
                        <div class="card" style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                            <h3 style="margin: 0; font-size: 2em;">${completedCount}</h3>
                            <p style="margin: 5px 0;">Completed</p>
                        </div>
                        <div class="card" style="text-align: center; padding: 20px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                            <h3 style="margin: 0; font-size: 2em;">LKR ${totalAmount.toFixed(0)}</h3>
                            <p style="margin: 5px 0;">Total Revenue</p>
                        </div>
                        <div class="card" style="text-align: center; padding: 20px; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                            <h3 style="margin: 0; font-size: 2em;">${completionRate}%</h3>
                            <p style="margin: 5px 0;">Completion Rate</p>
                        </div>
                    </div>

                    <div style="margin: 20px 0; padding: 20px; background: #faf5ff; border-radius: 10px;">
                        <div class="bill-row"><span>Doctor Fees</span><span><strong>LKR ${totalDoctorFees.toFixed(2)}</strong></span></div>
                        <div class="bill-row"><span>Hospital Charges</span><span><strong>LKR ${totalHospitalCharges.toFixed(2)}</strong></span></div>
                        <div class="bill-row"><span>Additional Services</span><span><strong>LKR ${totalAdditionalExpenses.toFixed(2)}</strong></span></div>
                        <div class="bill-row bill-total"><span>TOTAL REVENUE</span><span><strong>LKR ${totalAmount.toFixed(2)}</strong></span></div>
                        <div class="bill-row"><span>Report Generated</span><span>${new Date().toLocaleString()}</span></div>
                    </div>

                    ${patientDetailsTable}
                    
                    <button class="btn btn-primary no-print" onclick="window.print()">üñ®Ô∏è Print Report</button>
                `;
            } catch (error) {
                console.error('Error generating summary report:', error);
                showToast('Error generating report', 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            populateReportDropdowns();
            
            // Set default dates to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportStartDate').value = today;
            document.getElementById('reportEndDate').value = today;
            document.getElementById('hospitalStartDate').value = today;
            document.getElementById('hospitalEndDate').value = today;
            document.getElementById('summaryDate').value = today;
        });
    </script>
</body>
</html>