<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reports & Analytics - HMS</title>
    <link rel="stylesheet" href="/static/css/styles.css" />
  </head>
  <body>
    <div class="sidebar" id="sidebar"></div>
    <div class="topbar" id="topbar"></div>

    <div class="main-content">
      <!-- Tab Buttons -->
      <div class="tab-buttons no-print">
        <button class="tab-btn active" onclick="showReportTab('doctor')">
          Doctor Report
        </button>
        <button class="tab-btn" onclick="showReportTab('hospital')">
          Hospital Report
        </button>
        <button class="tab-btn" onclick="showReportTab('summary')">
          Summary Report
        </button>
      </div>

      <!-- Doctor Report Tab -->
      <div id="doctorReportTab">
        <div class="card no-print">
          <div class="form-grid">
            <div class="form-group">
              <label>Select Doctor</label>
              <select id="reportDoctor">
                <option value="">-- All Doctors --</option>
              </select>
            </div>
            <div class="form-group">
              <label>Start Date</label>
              <input type="date" id="reportStartDate" />
            </div>
            <div class="form-group">
              <label>End Date</label>
              <input type="date" id="reportEndDate" />
            </div>
            <div
              class="form-group"
              style="display: flex; align-items: flex-end"
            >
              <button class="btn btn-primary" onclick="generateDoctorReport()">
                Generate Report
              </button>
            </div>
          </div>
        </div>
        <div class="card" id="doctorReportContent" style="display: none"></div>
      </div>

      <!-- Hospital Report Tab -->
      <div id="hospitalReportTab" style="display: none">
        <div class="card no-print">
          <div class="form-grid">
            <div class="form-group">
              <label>Start Date</label>
              <input type="date" id="hospitalStartDate" />
            </div>
            <div class="form-group">
              <label>End Date</label>
              <input type="date" id="hospitalEndDate" />
            </div>
            <div
              class="form-group"
              style="display: flex; align-items: flex-end"
            >
              <button
                class="btn btn-primary"
                onclick="generateHospitalReport()"
              >
                Generate Report
              </button>
            </div>
          </div>
        </div>
        <div
          class="card"
          id="hospitalReportContent"
          style="display: none"
        ></div>
      </div>

      <!-- Summary Report Tab -->
      <div id="summaryReportTab" style="display: none">
        <div class="card no-print">
          <div class="form-grid">
            <div class="form-group">
              <label>Report Date</label>
              <input type="date" id="summaryDate" />
            </div>
            <div
              class="form-group"
              style="display: flex; align-items: flex-end"
            >
              <button class="btn btn-primary" onclick="generateSummaryReport()">
                Generate Daily Summary
              </button>
            </div>
          </div>
        </div>
        <div class="card" id="summaryReportContent" style="display: none"></div>
      </div>
    </div>

    <script src="/static/js/data.js"></script>
    <script src="/static/js/common.js"></script>
    <script src="/static/js/api.js"></script>
    <script>
      // Tab switching
      function showReportTab(tab) {
        document.querySelectorAll(".tab-btn").forEach((b, i) => {
          b.classList.toggle(
            "active",
            (tab === "doctor" && i === 0) ||
              (tab === "hospital" && i === 1) ||
              (tab === "summary" && i === 2)
          );
        });
        document.getElementById("doctorReportTab").style.display =
          tab === "doctor" ? "block" : "none";
        document.getElementById("hospitalReportTab").style.display =
          tab === "hospital" ? "block" : "none";
        document.getElementById("summaryReportTab").style.display =
          tab === "summary" ? "block" : "none";
      }

      // Populate doctor dropdown
      async function populateReportDropdowns() {
        try {
          const doctors = await API.Doctors.getAll("Active");
          document.getElementById("reportDoctor").innerHTML =
            '<option value="">-- All Doctors --</option>' +
            doctors
              .map(
                (d) =>
                  `<option value="${d.doctor_id}">${d.doctor_name}</option>`
              )
              .join("");
        } catch (error) {
          console.error("Error loading doctors:", error);
          showToast("Error loading doctors", "error");
        }
      }

      // Generate Doctor Report - Enhanced with Patient Details Table
      // Generate Doctor Report - Enhanced with Paid & Balance logic
    async function generateDoctorReport() {
    const doctorId = document.getElementById("reportDoctor").value;
    const startDate = document.getElementById("reportStartDate").value;
    const endDate = document.getElementById("reportEndDate").value;

    if (!startDate || !endDate) {
        showToast("Please select both start and end dates", "error");
        return;
    }

    try {
        // 1. Fetch Appointments and Vouchers in parallel
        const [doctorReport, appointments, allVouchers] = await Promise.all([
            API.Reports.getDoctorWise(startDate, endDate),
            API.Appointments.getAll({
                date_from: startDate,
                date_to: endDate,
                doctor_id: doctorId || undefined,
            }),
            fetch(`/api/vouchers?doctor_id=${doctorId || ""}`).then((res) => res.json()),
        ]);

        // 2. LOGIC: Patient Fees (Total Billed vs Collected)
        let patientTotalBilled = 0;
        let patientTotalPaid = 0;
        let patientTotalPending = 0;

        // 3. LOGIC: Doctor Fees (Accrued/Earned)
        let doctorTotalEarned = 0;

        appointments.forEach((appt) => {
            const docFee = parseFloat(appt.doctor_charges || 0);
            const hospFee = parseFloat(appt.hospital_charges || 0);
            const addFee = parseFloat(appt.additional_expenses || 0);
            const totalBill = parseFloat(appt.bill_total || (docFee + hospFee + addFee));

            patientTotalBilled += totalBill;
            doctorTotalEarned += docFee;

            if (appt.payment_status === "Paid") {
                patientTotalPaid += totalBill;
            } else {
                patientTotalPending += totalBill;
            }
        });

        // 4. LOGIC: Doctor Payouts (What hospital already paid the doctor via Vouchers)
        let totalActuallyPaidToDoctor = 0;
        const paidVouchers = allVouchers.filter(
            (v) =>
                v.doctor_id === doctorId &&
                v.status === "PAID" &&
                v.voucher_type === "DOCTOR_PAYMENT"
        );

        paidVouchers.forEach((v) => {
            totalActuallyPaidToDoctor += parseFloat(v.amount || 0);
        });

        // 5. Calculate Doctor Balance (What is still owed to the doctor)
        let doctorBalanceDue = doctorTotalEarned - totalActuallyPaidToDoctor;

        // 6. Doctor Header Info
        let doctorHeaderName = "All Doctors";
        let doctorHeaderSpec = "";
        if (doctorId) {
            const specificDoc = doctorReport.find((d) => d.doctor_id === doctorId);
            if (specificDoc) {
                doctorHeaderName = specificDoc.doctor_name;
                doctorHeaderSpec = specificDoc.specialization;
            }
        }

        const dateRange = startDate === endDate ? formatDate(startDate) : `${formatDate(startDate)} to ${formatDate(endDate)}`;

        // 7. Generate HTML Content
        let html = `
            <div class="card-title">üìä Comprehensive Financial Report - ${dateRange}</div>
            <p><strong>Doctor:</strong> ${doctorHeaderName} (${doctorHeaderSpec || "All"})</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                <div style="padding: 15px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <h4 style="margin-top: 0; color: #1e40af; border-bottom: 2px solid #e2e8f0; padding-bottom: 5px;">üë• Patient Collections</h4>
                    <div class="bill-row"><span>Total Billed:</span><span>LKR ${patientTotalBilled.toFixed(2)}</span></div>
                    <div class="bill-row" style="color: #059669;"><span>Total Collected (Paid):</span><span><strong>LKR ${patientTotalPaid.toFixed(2)}</strong></span></div>
                    <div class="bill-row" style="color: #dc2626;"><span>Total Outstanding (Pending):</span><span><strong>LKR ${patientTotalPending.toFixed(2)}</strong></span></div>
                </div>

                <div style="padding: 15px; background: #f0fdf4; border-radius: 12px; border: 1px solid #dcfce7;">
                    <h4 style="margin-top: 0; color: #166534; border-bottom: 2px solid #dcfce7; padding-bottom: 5px;">üë®‚Äç‚öïÔ∏è Doctor Settlement</h4>
                    <div class="bill-row"><span>Total Fees Earned:</span><span>LKR ${doctorTotalEarned.toFixed(2)}</span></div>
                    <div class="bill-row" style="color: #2563eb;"><span>Already Paid to Doctor:</span><span><strong>LKR ${totalActuallyPaidToDoctor.toFixed(2)}</strong></span></div>
                    <hr style="border: 0; border-top: 1px solid #dcfce7; margin: 10px 0;">
                    <div class="bill-row" style="color: ${doctorBalanceDue > 0 ? '#9a3412' : '#166534'};">
                        <span><strong>Hospital Balance Due:</strong></span>
                        <span><strong>LKR ${doctorBalanceDue.toFixed(2)}</strong></span>
                    </div>
                </div>
            </div>

            <h4>üìã Detailed Transaction Log</h4>
            <div style="overflow-x: auto; margin-bottom: 20px;">
                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <thead style="background: #4f46e5; color: white;">
                        <tr>
                            <th style="padding: 12px; text-align: left;">Date</th>
                            <th style="padding: 12px; text-align: left;">Patient</th>
                            <th style="padding: 12px; text-align: right;">Total Bill</th>
                            <th style="padding: 12px; text-align: right;">Doctor Fee</th>
                            <th style="padding: 12px; text-align: center;">Patient Payment</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appointments.length > 0 ? appointments.map((appt) => `
                            <tr style="border-bottom: 1px solid #f3f4f6;">
                                <td style="padding: 12px;">${formatDate(appt.appointment_date)}</td>
                                <td style="padding: 12px;">${appt.patient_name}</td>
                                <td style="padding: 12px; text-align: right;">LKR ${parseFloat(appt.bill_total).toFixed(2)}</td>
                                <td style="padding: 12px; text-align: right; font-weight: 600;">LKR ${parseFloat(appt.doctor_charges).toFixed(2)}</td>
                                <td style="padding: 12px; text-align: center;">
                                    <span style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; 
                                        ${appt.payment_status === "Paid" ? "background: #dcfce7; color: #166534;" : "background: #fee2e2; color: #991b1b;"}">
                                        ${appt.payment_status}
                                    </span>
                                </td>
                            </tr>
                        `).join("") : '<tr><td colspan="5" style="text-align:center; padding:20px;">No appointments found.</td></tr>'}
                    </tbody>
                </table>
            </div>

            ${doctorBalanceDue > 0 && doctorId ? `
                <div class="no-print" style="margin: 20px 0; padding: 20px; background: #fffbeb; border-radius: 10px; border: 1px dashed #f59e0b; text-align: center;">
                    <h5 style="margin-top: 0; color: #92400e;">Payment Outstanding</h5>
                    <p>Click below to create a voucher for the doctor's unpaid balance of <strong>LKR ${doctorBalanceDue.toFixed(2)}</strong></p>
                    <button class="btn btn-warning" onclick="createDoctorPaymentVoucher('${doctorId}', '${startDate}', '${endDate}', ${doctorBalanceDue})">
                        üìÑ Create Balance Payout Voucher
                    </button>
                </div>
            ` : ""}

            <button class="btn btn-primary no-print" onclick="window.print()">üñ®Ô∏è Print Financial Report</button>
        `;

        document.getElementById("doctorReportContent").style.display = "block";
        document.getElementById("doctorReportContent").innerHTML = html;
    } catch (error) {
        console.error("Error generating report:", error);
        showToast("Error loading financial data", "error");
    }
}
      // Create Doctor Payment Voucher
      async function createDoctorPaymentVoucher(
        doctorId,
        startDate,
        endDate,
        amount
      ) {
        try {
          const voucherData = {
            voucher_type: "DOCTOR_PAYMENT",
            doctor_id: doctorId,
            payment_period_start: startDate,
            payment_period_end: endDate,
            amount: amount,
            description: `Doctor payment for period ${startDate} to ${endDate}`,
            status: "PENDING_APPROVAL",
          };

          const response = await fetch("/api/vouchers", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(voucherData),
          });

          if (response.ok) {
            const voucher = await response.json();
            showToast(
              `Payment voucher ${voucher.voucher_number} created successfully`,
              "success"
            );

            // Ask if user wants to go to vouchers page
            if (
              confirm(
                "Voucher created successfully! Would you like to go to the vouchers page to approve it?"
              )
            ) {
              window.location.href = "/vouchers.html";
            } else {
              // Refresh the report to show updated status
              generateDoctorReport();
            }
          } else {
            const error = await response.json();
            showToast(`Error creating voucher: ${error.detail}`, "error");
          }
        } catch (error) {
          console.error("Error creating voucher:", error);
          showToast("Error creating payment voucher", "error");
        }
      }

      // Generate Hospital Report - Hospital Fees Only
      async function generateHospitalReport() {
        const startDate = document.getElementById("hospitalStartDate").value;
        const endDate = document.getElementById("hospitalEndDate").value;

        if (!startDate || !endDate) {
          showToast("Please select both start and end dates", "error");
          return;
        }

        try {
          // Get appointments for the date range
          const appointments = await API.Appointments.getAll({
            date_from: startDate,
            date_to: endDate,
          });

          // Calculate total hospital charges
          let totalHospitalCharges = 0;
          appointments.forEach((appointment) => {
            totalHospitalCharges += parseFloat(
              appointment.hospital_charges || 0
            );
          });

          const dateRange =
            startDate === endDate
              ? formatDate(startDate)
              : `${formatDate(startDate)} to ${formatDate(endDate)}`;

          // Create hospital charges details table
          let hospitalDetailsTable = "";
          if (appointments.length > 0) {
            hospitalDetailsTable = `
                        <h4>üè• Hospital Charges Details</h4>
                        <div style="overflow-x: auto; margin: 20px 0;">
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <thead style="background: #059669; color: white;">
                                    <tr>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">S.No</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">Token/Bill No</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">Patient Name</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">Doctor</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">Date</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid #e5e7eb;">Hospital Charges</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #e5e7eb;">Payment Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${appointments
                                      .map(
                                        (appointment, index) => `
                                        <tr style="border-bottom: 1px solid #f3f4f6;">
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6;">${
                                              index + 1
                                            }</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; font-weight: 600; color: #059669;">${
                                              appointment.token_number || "N/A"
                                            }</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; font-weight: 500;">${
                                              appointment.patient_name || "N/A"
                                            }</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6;">${
                                              appointment.doctor_name || "N/A"
                                            }</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6;">${formatDate(
                                              appointment.appointment_date
                                            )}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; text-align: right; font-weight: 600; color: #059669;">LKR ${parseFloat(
                                              appointment.hospital_charges || 0
                                            ).toFixed(2)}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; text-align: center;">
                                                <span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; 
                                                    ${
                                                      appointment.payment_status ===
                                                      "Paid"
                                                        ? "background: #dcfce7; color: #166534;"
                                                        : "background: #fef3c7; color: #92400e;"
                                                    }">
                                                    ${
                                                      appointment.payment_status ||
                                                      "Pending"
                                                    }
                                                </span>
                                            </td>
                                        </tr>
                                    `
                                      )
                                      .join("")}
                                </tbody>
                                <tfoot style="background: #f0fdf4; font-weight: 600;">
                                    <tr>
                                        <td colspan="5" style="padding: 12px; text-align: right; border-top: 2px solid #e5e7eb; font-size: 16px;">TOTAL HOSPITAL CHARGES:</td>
                                        <td style="padding: 12px; text-align: right; border-top: 2px solid #e5e7eb; color: #059669; font-size: 16px;">LKR ${totalHospitalCharges.toFixed(
                                          2
                                        )}</td>
                                        <td style="padding: 12px; border-top: 2px solid #e5e7eb;"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    `;
          } else {
            hospitalDetailsTable = `
                        <div style="margin: 20px 0; padding: 20px; background: #fef3c7; border-radius: 10px; text-align: center;">
                            <p style="margin: 0; color: #92400e;">No appointments found for the selected criteria.</p>
                        </div>
                    `;
          }

          document.getElementById("hospitalReportContent").style.display =
            "block";
          document.getElementById("hospitalReportContent").innerHTML = `
                    <div class="card-title">üè• Hospital Report - ${dateRange}</div>
                    <p><strong>Focus:</strong> Hospital Charges Only</p>
                    <div style="margin: 20px 0; padding: 20px; background: #f0fdf4; border-radius: 10px;">
                        <div class="bill-row"><span>Total Appointments</span><span><strong>${
                          appointments.length
                        }</strong></span></div>
                        <div class="bill-row bill-total"><span>TOTAL HOSPITAL CHARGES</span><span><strong>LKR ${totalHospitalCharges.toFixed(
                          2
                        )}</strong></span></div>
                        <div class="bill-row"><span>Report Generated</span><span>${new Date().toLocaleString()}</span></div>
                    </div>
                    
                    ${hospitalDetailsTable}
                    
                    <button class="btn btn-primary no-print" onclick="window.print()">üñ®Ô∏è Print Report</button>
                `;
        } catch (error) {
          console.error("Error generating hospital report:", error);
          showToast("Error generating report", "error");
        }
      }

      // Generate Summary Report - Patient Details Table
      async function generateSummaryReport() {
        const date = document.getElementById("summaryDate").value;

        if (!date) {
          showToast("Please select a date", "error");
          return;
        }

        try {
          // Get appointments for the selected date
          const appointments = await API.Appointments.getAll({
            date_from: date,
            date_to: date,
          });

          // Calculate totals from appointments
          let totalDoctorFees = 0;
          let totalHospitalCharges = 0;
          let totalAdditionalExpenses = 0;
          let totalAmount = 0;
          let completedCount = 0;
          let scheduledCount = 0;
          let cancelledCount = 0;

          appointments.forEach((appointment) => {
            totalDoctorFees += parseFloat(appointment.doctor_charges || 0);
            totalHospitalCharges += parseFloat(
              appointment.hospital_charges || 0
            );
            totalAdditionalExpenses += parseFloat(
              appointment.additional_expenses || 0
            );
            totalAmount += parseFloat(appointment.bill_total || 0);

            // Count appointment statuses
            const status = appointment.status || "Scheduled";
            if (status === "Completed") completedCount++;
            else if (status === "Cancelled") cancelledCount++;
            else scheduledCount++;
          });

          const completionRate =
            appointments.length > 0
              ? Math.round((completedCount / appointments.length) * 100)
              : 0;

          // Create patient details table
          let patientDetailsTable = "";
          if (appointments.length > 0) {
            patientDetailsTable = `
                        <h4>üìã Daily Patient Summary</h4>
                        <div style="overflow-x: auto; margin: 20px 0;">
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <thead style="background: #7c3aed; color: white;">
                                    <tr>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">S.No</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">Token/Bill No</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">Patient Name</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;">Doctor</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid #e5e7eb;">Doctor Fee</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid #e5e7eb;">Hospital Charges</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid #e5e7eb;">Additional</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 1px solid #e5e7eb;">Total</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #e5e7eb;">Status</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #e5e7eb;">Payment</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${appointments
                                      .map(
                                        (appointment, index) => `
                                        <tr style="border-bottom: 1px solid #f3f4f6;">
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6;">${
                                              index + 1
                                            }</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; font-weight: 600; color: #7c3aed;">${
                                              appointment.token_number || "N/A"
                                            }</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; font-weight: 500;">${
                                              appointment.patient_name || "N/A"
                                            }</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6;">${
                                              appointment.doctor_name || "N/A"
                                            }</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; text-align: right;">LKR ${parseFloat(
                                              appointment.doctor_charges || 0
                                            ).toFixed(2)}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; text-align: right;">LKR ${parseFloat(
                                              appointment.hospital_charges || 0
                                            ).toFixed(2)}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; text-align: right;">LKR ${parseFloat(
                                              appointment.additional_expenses ||
                                                0
                                            ).toFixed(2)}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; text-align: right; font-weight: 600;">LKR ${parseFloat(
                                              appointment.bill_total || 0
                                            ).toFixed(2)}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; text-align: center;">
                                                <span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; 
                                                    ${
                                                      appointment.status ===
                                                      "Completed"
                                                        ? "background: #dcfce7; color: #166534;"
                                                        : appointment.status ===
                                                          "Cancelled"
                                                        ? "background: #fee2e2; color: #dc2626;"
                                                        : "background: #dbeafe; color: #2563eb;"
                                                    }">
                                                    ${
                                                      appointment.status ||
                                                      "Scheduled"
                                                    }
                                                </span>
                                            </td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; text-align: center;">
                                                <span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; 
                                                    ${
                                                      appointment.payment_status ===
                                                      "Paid"
                                                        ? "background: #dcfce7; color: #166534;"
                                                        : "background: #fef3c7; color: #92400e;"
                                                    }">
                                                    ${
                                                      appointment.payment_status ||
                                                      "Pending"
                                                    }
                                                </span>
                                            </td>
                                        </tr>
                                    `
                                      )
                                      .join("")}
                                </tbody>
                                <tfoot style="background: #faf5ff; font-weight: 600;">
                                    <tr>
                                        <td colspan="4" style="padding: 12px; text-align: right; border-top: 2px solid #e5e7eb; font-size: 16px;">TOTALS:</td>
                                        <td style="padding: 12px; text-align: right; border-top: 2px solid #e5e7eb;">LKR ${totalDoctorFees.toFixed(
                                          2
                                        )}</td>
                                        <td style="padding: 12px; text-align: right; border-top: 2px solid #e5e7eb;">LKR ${totalHospitalCharges.toFixed(
                                          2
                                        )}</td>
                                        <td style="padding: 12px; text-align: right; border-top: 2px solid #e5e7eb;">LKR ${totalAdditionalExpenses.toFixed(
                                          2
                                        )}</td>
                                        <td style="padding: 12px; text-align: right; border-top: 2px solid #e5e7eb; color: #7c3aed; font-size: 16px;">LKR ${totalAmount.toFixed(
                                          2
                                        )}</td>
                                        <td colspan="2" style="padding: 12px; border-top: 2px solid #e5e7eb;"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    `;
          } else {
            patientDetailsTable = `
                        <div style="margin: 20px 0; padding: 20px; background: #fef3c7; border-radius: 10px; text-align: center;">
                            <p style="margin: 0; color: #92400e;">No appointments found for the selected date.</p>
                        </div>
                    `;
          }

          document.getElementById("summaryReportContent").style.display =
            "block";
          document.getElementById("summaryReportContent").innerHTML = `
                    <div class="card-title">üìà Daily Summary Report - ${formatDate(
                      date
                    )}</div>
                    
                    <div class="form-grid" style="margin: 20px 0;">
                        <div class="card" style="text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <h3 style="margin: 0; font-size: 2em;">${
                              appointments.length
                            }</h3>
                            <p style="margin: 5px 0;">Total Appointments</p>
                        </div>
                        <div class="card" style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                            <h3 style="margin: 0; font-size: 2em;">${completedCount}</h3>
                            <p style="margin: 5px 0;">Completed</p>
                        </div>
                        <div class="card" style="text-align: center; padding: 20px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                            <h3 style="margin: 0; font-size: 2em;">LKR ${totalAmount.toFixed(
                              0
                            )}</h3>
                            <p style="margin: 5px 0;">Total Revenue</p>
                        </div>
                        <div class="card" style="text-align: center; padding: 20px; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                            <h3 style="margin: 0; font-size: 2em;">${completionRate}%</h3>
                            <p style="margin: 5px 0;">Completion Rate</p>
                        </div>
                    </div>

                    <div style="margin: 20px 0; padding: 20px; background: #faf5ff; border-radius: 10px;">
                        <div class="bill-row"><span>Doctor Fees</span><span><strong>LKR ${totalDoctorFees.toFixed(
                          2
                        )}</strong></span></div>
                        <div class="bill-row"><span>Hospital Charges</span><span><strong>LKR ${totalHospitalCharges.toFixed(
                          2
                        )}</strong></span></div>
                        <div class="bill-row"><span>Additional Services</span><span><strong>LKR ${totalAdditionalExpenses.toFixed(
                          2
                        )}</strong></span></div>
                        <div class="bill-row bill-total"><span>TOTAL REVENUE</span><span><strong>LKR ${totalAmount.toFixed(
                          2
                        )}</strong></span></div>
                        <div class="bill-row"><span>Report Generated</span><span>${new Date().toLocaleString()}</span></div>
                    </div>

                    ${patientDetailsTable}
                    
                    <button class="btn btn-primary no-print" onclick="window.print()">üñ®Ô∏è Print Report</button>
                `;
        } catch (error) {
          console.error("Error generating summary report:", error);
          showToast("Error generating report", "error");
        }
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        populateReportDropdowns();

        // Set default dates to today
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("reportStartDate").value = today;
        document.getElementById("reportEndDate").value = today;
        document.getElementById("hospitalStartDate").value = today;
        document.getElementById("hospitalEndDate").value = today;
        document.getElementById("summaryDate").value = today;
      });
    </script>
  </body>
</html>
